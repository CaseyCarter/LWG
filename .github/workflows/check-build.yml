# A workflow to check generating the HTML lists works.
# The pages generated by this will have incorrect "Last modified" dates
# for the issues, because there is no meta-date/dates file used here.
# That's OK, because this is just a quick check to ensure that the XML
# is well-formed and the lists can be generated, suitable for checking
# pull requests are OK to merge.

name: Check HTML generation

on:
  pull_request:
    branches: [ master ]
  push:
    branches: [ master ]

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Check for carriage returns
        run: |
          if grep -IUrl --exclude-dir=.git . -e $'\r'; then
            echo "Sorry, carriage returns are not allowed in the repo."
            exit 1
          fi

      - name: Setup xmllint
        uses: Bpolitycki/setup-xmllint-action@1.0.1

      - name: Validate XML issue files
        run: >
          find xml -name 'issue*.xml' -print0 |
          xargs -0 -P $(getconf _NPROCESSORS_ONLN) -n 128 xmllint --noout --nowarning --dtdvalid xml/lwg-issue.dtd

      - name: Setup latest cmake and ninja
        uses: lukka/get-cmake@latest

      - name: Prepare build system
        run: cmake -B out -G Ninja -DCMAKE_BUILD_TYPE=Debug

      - name: Compile binary programs
        run: ninja -C out -v

      - name: Generate HTML lists
        run: ninja -C out -v build_lists
