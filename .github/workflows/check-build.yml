# A workflow to check generating the HTML lists works.
# The pages generated by this will have incorrect "Last modified" dates
# for the issues, because there is no meta-date/dates file used here.
# That's OK, because this is just a quick check to ensure that the XML
# is well-formed and the lists can be generated, suitable for checking
# pull requests are OK to merge.

name: Check HTML generation

on:
  pull_request:
    branches: [ master ]
  push:
    branches: [ master ]

jobs:
  crlf:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 1

    - name: Check for carriage returns
      run: |
        if grep -IUrl --exclude-dir=.git . -e $'\r'; then
          echo "Sorry, carriage returns are not allowed in the repo."
          exit 1
        fi

  xmllint:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 1

    - name: Setup cmake and ninja
      uses: lukka/get-cmake@latest

    - name: Prepare build
      run: cmake -B out -G Ninja

    - name: Setup xmllint
      uses: Bpolitycki/setup-xmllint-action@1.0.1

    - name: XML validation
      run: cmake --build out -t lint

  build:
    runs-on: ubuntu-latest
    needs: [crlf,xmllint]
    permissions:
      contents: read

    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 1

    - name: Setup cmake and ninja
      uses: lukka/get-cmake@latest

    - name: Prepare build
      run: cmake -B out -G Ninja

    - name: Compile binary programs
      run: cmake --build out

    - name: Generate HTML lists
      run: cmake --build out -t build_lists
